version: '3.9'
services:
 ## Nginx Proxy
 #  web:
 #   image: nginx:alpine
 #   volumes:
 #    - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
 #   #  - ../etc/:/etc/nginx/certs
 #   ports:
 #    - '80:80'
 #    - '443:443'
 #   restart: always
 #   depends_on:
 #    - backend
 #    #  - frontend
 #    - neo4j
 #   environment:
 #    - NGINX_PORT=80
 #   networks:
 #    - intern
 #    - extern

 ## Vue (Nginx) Frontend
 frontend:
  container_name: frontend_prod
  build:
   context: ./client
   dockerfile: Dockerfile.prod
  restart: on-failure
  depends_on:
   - backend
  ports:
   - '80:80'

 ## NodeJS-Express Backend
 backend:
  container_name: backend_prod
  build:
   context: ./server
   dockerfile: Dockerfile.prod
  #  TODO: Remove ports as soon as nginx setup works?
  ports:
   - '8080:8080'
  restart: on-failure
  environment:
   - APP_PORT=${APP_PORT}
   - NEO4J_BOLT_PORT=${NEO4J_BOLT_PORT}
   - NEO4J_HTTPS_PORT=${NEO4J_HTTPS_PORT}
   - NEO4J_USER=${NEO4J_USER}
   - NEO4J_PW=${NEO4J_PW}
  depends_on:
   - neo4j

 #  Neo4j Database
 neo4j:
  container_name: neo4j
  image: neo4j:5.19
  restart: unless-stopped
  ports:
   - 7474:7474
   - 7687:7687
  volumes:
   - ./neo4j/plugins:/var/lib/neo4j/plugins
   - ./neo4j/backups:/var/lib/neo4j/backups
   - ./neo4j/data:/var/lib/neo4j/data
  environment:
   NEO4J_AUTH: ${NEO4J_USER}/${NEO4J_PW}
   NEO4J_PLUGINS: '["apoc", "apoc-extended"]'
   apoc.initializer.neo4j.0: CREATE CONSTRAINT collection_uuid IF NOT EXISTS FOR (c:Collection) REQUIRE c.uuid IS UNIQUE
   apoc.initializer.neo4j.1: CREATE CONSTRAINT character_uuid IF NOT EXISTS FOR (ch:Character) REQUIRE ch.uuid IS UNIQUE
   apoc.initializer.neo4j.2: CREATE CONSTRAINT annotation_uuid IF NOT EXISTS FOR (a:Annotation) REQUIRE a.uuid IS UNIQUE
